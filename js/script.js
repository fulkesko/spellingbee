const DICCIONARIO = {
    "1_grade": {
        "Normal Round": [
            "leg", "ant", "small", "got", "pet",
            "back", "Max", "pen", "dad", "pot",
            "bag", "lip", "tent", "fat", "quick",
            "big", "hop", "up", "Ron", "rock",
            "comb", "sit", "wig", "lock", "sick",
            "can", "not", "way", "fish", "see",
            "rat", "pants", "wet", "help", "sad",
            "fits", "pat", "wing", "hot", "song",
            "bad", "mat", "use", "fox", "ring",
            "did", "man", "van", "kit", "pen"
        ],
        "Extra Round": [

        ]
    }, "2_grade": {
        "Normal Round": [
            "feathers", "afraid", "trunk", "cake", "lost",
            "again", "friends", "sing", "always", "games",
            "think", "dance", "monkey", "baby", "her",
            "Tuesday", "dresses", "nothing", "ball", "hurry",
            "slower", "club", "lucky", "anyone", "growing",
            "spring", "chair", "morning", "after", "heavy",
            "under", "ducks", "our", "bigger", "Jack",
            "water", "egg", "nose", "bird", "window",
            "ear", "saddest", "body", "July", "everyone",
            "sang", "wish", "kisses", "fastest", "seed"
        ],
        "Extra Round": [
            "leg", "ant", "small", "got", "pet",
            "back", "Max", "pen", "dad", "pot",
            "bag", "lip", "tent", "fat", "quick",
            "big", "hop", "up", "Ron", "rock",
            "comb", "sit", "wig", "lock", "sick",
            "can", "not", "way", "fish", "see",
            "rat", "pants", "wet", "help", "sad",
            "fits", "pat", "wing", "hot", "song",
            "bad", "mat", "use", "fox", "ring",
            "did", "man", "van", "kit", "pen"
        ]
    }, "3_grade": {
        "Normal Round": [
            "experiment", "chase", "morning", "state", "world",
            "country", "enjoy", "machines", "miss", "safe",
            "shape", "woman", "bunch", "early", "listen",
            "rescue", "whale", "build", "dust", "spider",
            "nests", "someone", "wonderful", "cover", "excited",
            "lunch", "smile", "talking", "climb", "everything",
            "lemonade", "late", "people", "amphibian", "dropping",
            "hungry", "pineapple", "vapor", "brave", "drawing",
            "horse", "vote", "born", "danger", "Wednesday",
            "mammals", "teacher", "amazing", "different", "fire"
        ],
        "Extra Round": [
            "feathers", "afraid", "trunk", "cake", "lost",
            "again", "friends", "sing", "always", "games",
            "think", "dance", "monkey", "baby", "her",
            "Tuesday", "dresses", "nothing", "ball", "hurry",
            "slower", "club", "lucky", "anyone", "growing",
            "spring", "chair", "morning", "after", "heavy",
            "under", "ducks", "our", "bigger", "Jack",
            "water", "egg", "nose", "bird", "window",
            "ear", "saddest", "body", "July", "everyone",
            "sang", "wish", "kisses", "fastest", "seed"
        ]
    }, "4_grade": {
        "Normal Round": [
            "Sunday", "motion", "thousand", "Christmas", "gardener",
            "minute", "soap", "boring", "fridge", "worried",
            "million", "sequence", "butterfly", "flippers", "uniform",
            "mechanic", "quarter", "because", "envelope", "spotted",
            "together", "March", "private", "bicycle", "enough",
            "worth", "leave", "passenger", "geography", "path",
            "backyard", "dynamic", "glove", "hatch", "penguin",
            "actor", "dessert", "twice", "August", "daughter",
            "tooth", "great", "parents", "actually", "chess",
            "wasn’t", "through", "November", "aunts", "character"
        ],
        "Extra Round": [
            "experiment", "chase", "morning", "state", "world",
            "country", "enjoy", "machines", "miss", "safe",
            "shape", "woman", "bunch", "early", "listen",
            "rescue", "whale", "build", "dust", "spider",
            "nests", "someone", "wonderful", "cover", "excited",
            "lunch", "smile", "talking", "climb", "everything",
            "lemonade", "late", "people", "amphibian", "dropping",
            "hungry", "pineapple", "vapor", "brave", "drawing",
            "horse", "vote", "born", "danger", "Wednesday",
            "mammals", "teacher", "amazing", "different", "fire"
        ]
    }, "5_grade": {
        "Normal Round": [
            "newspaper", "shopping", "camera", "explore", "waitress",
            "nowhere", "screen", "business", "electricity", "young",
            "kingdom", "relaxing", "breakfast", "dollar", "visited",
            "join", "quick", "before", "didn’t", "umbrella",
            "juice", "quietly", "autumn", "choose", "tomorrow",
            "journey", "people", "assistant", "correct", "traffic",
            "introduce", "potatoes", "August", "crowded", "summer",
            "healthy", "photography", "address", "college", "strange",
            "hobby", "passport", "anybody", "cinnamon", "sometimes",
            "exciting", "message", "accident", "chemist", "sentence"
        ],
        "Extra Round": [
            "Sunday", "motion", "thousand", "Christmas", "gardener",
            "minute", "soap", "boring", "fridge", "worried",
            "million", "sequence", "butterfly", "flippers", "uniform",
            "mechanic", "quarter", "because", "envelope", "spotted",
            "together", "March", "private", "bicycle", "enough",
            "worth", "leave", "passenger", "geography", "path",
            "backyard", "dynamic", "glove", "hatch", "penguin",
            "actor", "dessert", "twice", "August", "daughter",
            "tooth", "great", "parents", "actually", "chess",
            "wasn’t", "through", "November", "aunts", "character"
        ]
    }, "6_grade": {
        "Normal Round": [
            "noisy", "Switzerland", "career", "guide", "windscreen",
            "medicine", "special", "campsite", "glasses", "wilderness",
            "luggage", "spaghetti", "building", "favourite", "yourself",
            "kilometre", "sweater", "busy", "fantastic", "women",
            "journalist", "somewhere", "brought", "foreign", "wedding",
            "impossible", "surprised", "blanket", "factory", "wasn’t",
            "hosts", "telephone", "quiet", "scratch", "amazing",
            "downstairs", "vegetable", "heavy", "couldn’t", "affirmative",
            "download", "thunderstorm", "healthy", "passenger", "advance",
            "comfortable", "thousand", "hairdryer", "opposite", "account"
        ],
        "Extra Round": [
            "newspaper", "shopping", "camera", "explore", "waitress",
            "nowhere", "screen", "business", "electricity", "young",
            "kingdom", "relaxing", "breakfast", "dollar", "visited",
            "join", "quick", "before", "didn’t", "umbrella",
            "juice", "quietly", "autumn", "choose", "tomorrow",
            "journey", "people", "assistant", "correct", "traffic",
            "introduce", "potatoes", "August", "crowded", "summer",
            "healthy", "photography", "address", "college", "strange",
            "hobby", "passport", "anybody", "cinnamon", "sometimes",
            "exciting", "message", "accident", "chemist", "sentence"
        ]
    }

};

let ELEMENTOS = {};

function refreshELEMENTOS() {
    ELEMENTOS = {
        texto: document.getElementById('texto'),
        numero: document.getElementById('numero'),
        dropdownMenuButton: document.getElementById('dropdownMenuButton'),
        icono: document.getElementById('icono')
    };
}
const GRADES_MAP = {
    "1_grade": "1st Grade",
    "2_grade": "2nd Grade",
    "3_grade": "3rd Grade",
    "4_grade": "4th Grade",
    "5_grade": "5th Grade",
    "6_grade": "6th Grade"
};

function updateTooltip(grade, round) {
    const icono = document.getElementById('icono');
    if (!icono) return;
    const pool = (DICCIONARIO?.[grade]?.[round]) || [];
    const used = getUsedSet(grade, round);
    const left = pool.length - used.size;
    icono.setAttribute('title', `${left} ${left === 1 ? 'word left' : 'words left' } for ${round}`);
}

let intervalo;
let palabrasSeleccionadas = [];


const USED = {};

function getUsedSet(grade, round) {
    if (!USED[grade]) USED[grade] = {};
    if (!USED[grade][round]) USED[grade][round] = new Set();
    return USED[grade][round];
}

function resetearAnimacion() {
    ELEMENTOS.texto.textContent = '';
    const abeja = document.getElementById('abeja');
    abeja.style.opacity = '0';
    abeja.classList.remove('girar-abeja');
}

function girarNumeros(grade) {
    const E = ELEMENTOS;
    if (!E?.icono || E.icono.getAttribute('alt') === 'disabled') return;

    const roundValue = E.dropdownMenuButton?.getAttribute('value');
    if (!roundValue || roundValue === 'notselect') {
        resetearAnimacion();
        iniciarAnimacionEscritura("Bzz choose a round");
        return;
    }

    const pool = (DICCIONARIO?.[grade]?.[roundValue]) || [];
    const total = pool.length;
    const used = getUsedSet(grade, roundValue);
    const restantes = total - used.size;

    E.numero.textContent = '0';
    E.numero.style.paddingTop = '15%';
    E.numero.style.fontSize = '7.5em';

    // si no quedan, no animes
    if (restantes <= 0) {
        resetearAnimacion();
        iniciarAnimacionEscritura("Bzz I ran out of Words");
        E.icono.setAttribute('title', '0 words left');   // ← plural
        E.icono.setAttribute('alt', 'enabled');
        return;
    }

    E.icono.setAttribute('alt', 'disabled');
    resetearAnimacion();

    intervalo = setInterval(() => {
        const r = getRandomInt(1, total + 1);
        E.numero.textContent = r;
    }, 100);

    setTimeout(() => {
        clearInterval(intervalo);

        let finalNum, palabraAsociada;
        do {
            finalNum = getRandomInt(1, total + 1);
            palabraAsociada = pool[finalNum - 1];
        } while (used.has(palabraAsociada));

        E.numero.textContent = finalNum;
        used.add(palabraAsociada);

        iniciarAnimacionEscritura(palabraAsociada, E.numero, "");

        // tooltip para ESTE grade+round
        updateTooltip(grade, roundValue);
        E.icono.setAttribute('alt', 'enabled');
    }, 2000);
}



function iniciarAnimacionEscritura(palabra, numeroDiv) {
    const searchIcon = document.getElementById('icono');
    const contenedorTexto = document.getElementById('texto');
    const abeja = document.getElementById('abeja');
    let indice = 0;



    function escribir() {
        if (indice < palabra.length) {
            contenedorTexto.textContent += palabra.charAt(indice);


            abeja.style.left = (contenedorTexto.offsetWidth + 20) + 'px';
            abeja.style.bottom = 150 + 'px';
            ajustarTamanoTexto();
            indice++;
            setTimeout(escribir, 100);


            if (indice == 1) {
                abeja.style.opacity = '1';
            }
        } else {
            // Gira la abeja hacia la izquierda
            abeja.classList.add('girar-abeja');
            if (!numeroDiv) {
                return;
            }
            searchIcon.setAttribute('alt', 'enabled');
            const contenedorTabla = document.querySelector('[alt="contenedor_tabla"]');
            contenedorTabla.style = '';
            agregarPalabraATabla2(numeroDiv.textContent, palabra);


        }
    }

    escribir(); // Iniciar la animación
}

function ajustarTamanoTexto() {
    const contenedor = document.getElementById('contenedor');
    const texto = ELEMENTOS.texto;

    let fontSize = 10;
    texto.style.fontSize = fontSize + 'em';


    setTimeout(() => {
        while ((texto.scrollWidth > contenedor.clientWidth || texto.scrollHeight > contenedor.clientHeight) && fontSize > 0.5) {
            fontSize -= 0.3;
            texto.style.fontSize = fontSize + 'em';
        }
    }, 1);
}

function agregarPalabraATabla(id, palabra) {
    const tabla = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
    const nuevaFila = tabla.insertRow(0);

    // Agregar ID
    let celdaId = nuevaFila.insertCell(0);
    // usar textContent en vez de innerHTML para preservar exactamente el texto
    celdaId.textContent = id;
    celdaId.style.textTransform = 'none';

    // Agregar Palabra
    let celdaPalabra = nuevaFila.insertCell(1);
    // textContent preserva mayúsculas/minúsculas tal cual
    celdaPalabra.textContent = palabra;
    // prevenir que CSS global aplique text-transform (lowercase/uppercase)
    celdaPalabra.style.textTransform = 'none';
    // opcional: guardar el original por si lo necesitas luego
    celdaPalabra.setAttribute('data-original-word', palabra);
}

function agregarPalabraATabla2(id, palabra) {
    const tabla = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
    const nuevaFila = tabla.insertRow(0);


    let celdaId = nuevaFila.insertCell(0);
    celdaId.textContent = id;
    celdaId.style.textTransform = 'none';


    let celdaPalabra = nuevaFila.insertCell(1);
    celdaPalabra.textContent = palabra;
    celdaPalabra.style.textTransform = 'none';
    celdaPalabra.setAttribute('data-original-word', palabra);
}

function selectRonda(ronda) {
    const btn = document.getElementById('dropdownMenuButton');
    const roundKey = `${ronda} Round`;

    btn.innerHTML = `<i class="fa fa-cog fa-spin fa-1x fa-fw fa-sm text-white-50"></i> ${roundKey}`;
    btn.setAttribute('value', roundKey);
    if (ELEMENTOS.icono) ELEMENTOS.icono.setAttribute('alt', 'enabled');
    updateTooltip(STATE.grade, roundKey);
}


function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min) + min);
}

//view
function loadBanner() {
    fetch("views/banner.html")
        .then(response => {
            if (!response.ok) {
                throw new Error("No se pudo cargar banner.html");
            }
            return response.text();
        })
        .then(html => {
            document.getElementById("container-body").innerHTML = html;
        })
        .catch(error => console.error("Error cargando banner:", error));
}


function loadContent(level) {
    fetch("views/baseview.html")
        .then(response => {
            if (!response.ok) throw new Error("No se pudo cargar baseview.html");
            return response.text();
        })
        .then(html => {
            document.getElementById("container-body").innerHTML = html;
            refreshELEMENTOS();

            const titulo = document.getElementById("title");
            if (titulo && GRADES_MAP[level]) {
                titulo.innerHTML = `<img src="img/bee.png" width="60" height="60" alt=""> ${GRADES_MAP[level]}`;
            }
            window.STATE = { grade: level, name: GRADES_MAP[level] };

            const dropdownBtn = document.getElementById("dropdownMenuButton");
            if (dropdownBtn) {
                dropdownBtn.innerHTML = `<i class="fa fa-cog fa-spin fa-1x fa-fw fa-sm text-white-50"></i> Normal Round`;
                dropdownBtn.setAttribute("value", "Normal Round");
            }

            const icono = document.getElementById('icono');
            if (icono) {
                icono.setAttribute("onclick", `girarNumeros('${level}')`);
                updateTooltip(level, "Normal Round");
            }
            const resetbtn = document.getElementById("resetbutton");
            if (resetbtn) {
                resetbtn.removeAttribute("href");
                resetbtn.setAttribute("onclick", `loadContent('${level}')`);
            }
        })
        .catch(error => console.error("Error cargando vista:", error));
}


function setActiveGrade(element, level) {
    document.querySelectorAll('#collapseUtilities .collapse-item')
        .forEach(el => el.classList.remove('active'));
    element.classList.add('active');
    loadContent(level);
}

$(function () {
    $('[data-toggle="tooltip"]').tooltip()
})
